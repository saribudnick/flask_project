<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Secure Login | Group 251891</title>
    <link rel="stylesheet" href="{{ url_for('static', filename='css/style.css') }}">
    <link href="https://fonts.googleapis.com/css2?family=JetBrains+Mono:wght@400;600&family=Space+Grotesk:wght@400;500;600;700&display=swap" rel="stylesheet">
</head>
<body>
    <div class="container">
        <!-- Security Badge -->
        <div class="security-badge">
            <span class="badge-icon">üîê</span>
            <span class="badge-text">Sari & Yam | Defense-in-Depth Authentication</span>
        </div>

        <!-- Login Card -->
        <div class="login-card">
            <div class="card-header">
                <h1>Secure Login</h1>
                <p class="creators">Sari & Yam</p>
                <p class="group-seed">Group Seed: <code>251891</code></p>
            </div>

            <!-- Status Messages -->
            <div id="status-message" class="status-message hidden"></div>

            <!-- Login Form -->
            <form id="login-form" class="login-form">
                <div class="form-group">
                    <label for="username">Username</label>
                    <input type="text" id="username" name="username" placeholder="Enter username" required>
                </div>

                <div class="form-group">
                    <label for="password">Password</label>
                    <input type="password" id="password" name="password" placeholder="Enter password" required>
                </div>

                <!-- TOTP Section (hidden by default) -->
                <div id="totp-section" class="form-group hidden">
                    <label for="totp_code">TOTP Code</label>
                    <input type="text" id="totp_code" name="totp_code" placeholder="6-digit code" maxlength="6" pattern="[0-9]{6}">
                </div>

                <!-- CAPTCHA Section (always visible) -->
                <div id="captcha-section" class="captcha-section-visible">
                    <div class="captcha-header">
                        <span>üîë CAPTCHA Token</span>
                        <small>Required after 3 failed attempts</small>
                    </div>
                    
                    <div class="captcha-row">
                        <input type="text" id="captcha_token" name="captcha_token" placeholder="Token will appear here">
                        <button type="button" id="get-captcha-btn" class="btn btn-token">
                            Get Token
                        </button>
                    </div>
                    <small class="captcha-hint">Group Seed: <code>251891</code></small>
                </div>

                <button type="submit" id="login-btn" class="btn btn-primary">
                    <span id="btn-text">Login</span>
                    <span id="btn-loader" class="loader hidden"></span>
                </button>
            </form>

            <!-- Account Lockout Warning -->
            <div id="lockout-warning" class="lockout-warning hidden">
                <div class="lockout-icon">üîí</div>
                <h3>Account Locked</h3>
                <p id="lockout-message">Too many failed attempts</p>
                <div class="lockout-timer">
                    <span>Time remaining: </span>
                    <span id="lockout-countdown">--:--</span>
                </div>
            </div>

            <!-- Link to Register -->
            <div class="form-footer">
                <p>Don't have an account? <a href="/register">Create one</a></p>
            </div>
        </div>

        <!-- Defense Status Panel -->
        <div class="defense-panel">
            <h3>üõ°Ô∏è Active Defenses</h3>
            <div class="defense-grid">
                <div class="defense-item active">
                    <span class="defense-icon">‚ö°</span>
                    <span class="defense-name">Rate Limiting</span>
                    <span class="defense-detail">15/min per IP</span>
                </div>
                <div class="defense-item active">
                    <span class="defense-icon">ü§ñ</span>
                    <span class="defense-name">CAPTCHA</span>
                    <span class="defense-detail">After 3 fails</span>
                </div>
                <div class="defense-item active">
                    <span class="defense-icon">üîí</span>
                    <span class="defense-name">Account Lockout</span>
                    <span class="defense-detail">5 fails ‚Üí 15 min</span>
                </div>
                <div class="defense-item active">
                    <span class="defense-icon">üîê</span>
                    <span class="defense-name">Argon2id + Pepper</span>
                    <span class="defense-detail">64MB memory</span>
                </div>
            </div>
        </div>

        <!-- Attempt Counter -->
        <div class="attempt-counter">
            <span id="attempt-count">0</span> login attempts this session
        </div>
    </div>

    <script>
        const GROUP_SEED = '251891';
        const API_BASE = '';
        let attemptCount = 0;
        let captchaToken = null;
        let lockoutTimer = null;

        // DOM Elements
        const loginForm = document.getElementById('login-form');
        const statusMessage = document.getElementById('status-message');
        const totpSection = document.getElementById('totp-section');
        const lockoutWarning = document.getElementById('lockout-warning');
        const getCaptchaBtn = document.getElementById('get-captcha-btn');
        const attemptCountEl = document.getElementById('attempt-count');
        const loginBtn = document.getElementById('login-btn');
        const btnText = document.getElementById('btn-text');
        const btnLoader = document.getElementById('btn-loader');

        // Show status message
        function showStatus(message, type = 'info') {
            statusMessage.textContent = message;
            statusMessage.className = `status-message ${type}`;
            statusMessage.classList.remove('hidden');
            
            if (type === 'success') {
                setTimeout(() => statusMessage.classList.add('hidden'), 3000);
            }
        }

        // Hide status message
        function hideStatus() {
            statusMessage.classList.add('hidden');
        }

        // Update attempt counter
        function updateAttemptCount() {
            attemptCount++;
            attemptCountEl.textContent = attemptCount;
        }

        // Set loading state
        function setLoading(loading) {
            loginBtn.disabled = loading;
            btnText.textContent = loading ? 'Authenticating...' : 'Login';
            btnLoader.classList.toggle('hidden', !loading);
        }

        // Get CAPTCHA token
        async function getCaptchaToken() {
            getCaptchaBtn.disabled = true;
            getCaptchaBtn.textContent = '‚è≥ Fetching...';
            
            try {
                const response = await fetch(`${API_BASE}/admin/get_captcha_token?group_seed=${GROUP_SEED}`);
                const data = await response.json();
                
                if (data.captcha_token) {
                    captchaToken = data.captcha_token;
                    // Put the token in the input field
                    document.getElementById('captcha_token').value = captchaToken;
                    showStatus('‚úÖ Token fetched (Group Seed: 251891)', 'success');
                    getCaptchaBtn.textContent = '‚úÖ Done';
                    setTimeout(() => { getCaptchaBtn.textContent = 'Get Token'; }, 2000);
                } else {
                    showStatus('Failed to get CAPTCHA token', 'error');
                    getCaptchaBtn.textContent = 'Retry';
                }
            } catch (error) {
                showStatus('Error: ' + error.message, 'error');
                getCaptchaBtn.textContent = 'Retry';
            }
            
            getCaptchaBtn.disabled = false;
        }

        // Start lockout countdown
        function startLockoutCountdown(seconds) {
            lockoutWarning.classList.remove('hidden');
            loginForm.classList.add('hidden');
            
            const countdownEl = document.getElementById('lockout-countdown');
            
            function updateCountdown() {
                const mins = Math.floor(seconds / 60);
                const secs = seconds % 60;
                countdownEl.textContent = `${mins}:${secs.toString().padStart(2, '0')}`;
                
                if (seconds <= 0) {
                    clearInterval(lockoutTimer);
                    lockoutWarning.classList.add('hidden');
                    loginForm.classList.remove('hidden');
                    showStatus('Account unlocked. You can try again.', 'info');
                }
                seconds--;
            }
            
            updateCountdown();
            lockoutTimer = setInterval(updateCountdown, 1000);
        }

        // Handle login form submission
        loginForm.addEventListener('submit', async (e) => {
            e.preventDefault();
            hideStatus();
            setLoading(true);
            updateAttemptCount();
            
            const username = document.getElementById('username').value;
            const password = document.getElementById('password').value;
            const totpCode = document.getElementById('totp_code').value;
            const captchaTokenInput = document.getElementById('captcha_token').value;
            
            // Prepare request body
            const body = { username, password };
            
            // Add TOTP code if provided
            if (totpCode) {
                body.totp_code = totpCode;
            }
            
            // Add CAPTCHA token if available (from input field)
            if (captchaTokenInput) {
                body.captcha_token = captchaTokenInput;
            }
            
            // Determine endpoint
            const endpoint = totpCode ? '/auth/login_totp' : '/auth/login';
            
            try {
                const response = await fetch(API_BASE + endpoint, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(body)
                });
                
                const data = await response.json();
                
                if (response.ok && data.token) {
                    // Success!
                    showStatus('‚úÖ Login successful! Redirecting...', 'success');
                    localStorage.setItem('jwt_token', data.token);
                    // Redirect or update UI as needed
                    
                } else if (response.status === 423) {
                    // Account locked
                    const lockoutMessage = document.getElementById('lockout-message');
                    lockoutMessage.textContent = data.message || 'Account is locked due to too many failed attempts.';
                    startLockoutCountdown(data.locked_until_seconds || 900);
                    
                } else if (response.status === 403) {
                    // CAPTCHA required or TOTP required
                    if (data.captcha_required) {
                        showStatus('ü§ñ CAPTCHA required! Click "Get Token" button, then try again.', 'warning');
                        // Highlight the CAPTCHA section
                        document.getElementById('captcha-section').style.borderColor = '#f59e0b';
                        document.getElementById('captcha_token').focus();
                    } else if (data.totp_required) {
                        totpSection.classList.remove('hidden');
                        showStatus('üîê TOTP code required. Enter your 6-digit code.', 'warning');
                    } else {
                        showStatus(data.message || data.error || 'Access forbidden', 'error');
                    }
                    
                } else if (response.status === 401) {
                    // Invalid credentials
                    let message = '‚ùå Invalid credentials';
                    
                    if (data.account_locked) {
                        message = `üîí ${data.message}`;
                        startLockoutCountdown(data.locked_until_seconds || 900);
                    } else if (data.captcha_required) {
                        message += '. CAPTCHA now required - click "Get Token"!';
                        document.getElementById('captcha-section').style.borderColor = '#f59e0b';
                    }
                    
                    showStatus(message, 'error');
                    
                } else if (response.status === 429) {
                    // Rate limited
                    showStatus('‚ö° Rate limit exceeded. Please wait a moment.', 'error');
                    
                } else {
                    showStatus(data.error || 'Login failed', 'error');
                }
                
            } catch (error) {
                showStatus('Network error: ' + error.message, 'error');
            }
            
            setLoading(false);
        });

        // Get CAPTCHA token button handler
        getCaptchaBtn.addEventListener('click', getCaptchaToken);

        // Clear TOTP when username changes
        document.getElementById('username').addEventListener('input', () => {
            totpSection.classList.add('hidden');
            document.getElementById('totp_code').value = '';
        });
    </script>
</body>
</html>

