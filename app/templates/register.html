<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Create Account | Group 251891</title>
    <link rel="stylesheet" href="{{ url_for('static', filename='css/style.css') }}">
    <link href="https://fonts.googleapis.com/css2?family=JetBrains+Mono:wght@400;600&family=Space+Grotesk:wght@400;500;600;700&display=swap" rel="stylesheet">
</head>
<body>
    <div class="container">
        <!-- Security Badge -->
        <div class="security-badge">
            <span class="badge-icon">ğŸ”</span>
            <span class="badge-text">Sari & Yam | Defense-in-Depth Authentication</span>
        </div>

        <!-- Register Card -->
        <div class="login-card">
            <div class="card-header">
                <h1>Create Account</h1>
                <p class="creators">Sari & Yam</p>
                <p class="group-seed">Group Seed: <code>251891</code></p>
            </div>

            <!-- Status Messages -->
            <div id="status-message" class="status-message hidden"></div>

            <!-- Register Form -->
            <form id="register-form" class="login-form">
                <div class="form-group">
                    <label for="username">Username</label>
                    <input type="text" id="username" name="username" placeholder="Choose a username" required minlength="3">
                </div>

                <div class="form-group">
                    <label for="password">Password</label>
                    <input type="password" id="password" name="password" placeholder="Choose a password" required minlength="4">
                    <small class="input-hint">Minimum 4 characters</small>
                </div>

                <div class="form-group">
                    <label for="confirm_password">Confirm Password</label>
                    <input type="password" id="confirm_password" name="confirm_password" placeholder="Confirm password" required>
                </div>

                <!-- CAPTCHA Section (always visible) -->
                <div id="captcha-section" class="captcha-section-visible">
                    <div class="captcha-header">
                        <span>ğŸ”‘ CAPTCHA Token</span>
                        <small>Required after 3 failed attempts</small>
                    </div>
                    
                    <div class="captcha-row">
                        <input type="text" id="captcha_token" name="captcha_token" placeholder="Token will appear here">
                        <button type="button" id="get-captcha-btn" class="btn btn-token">
                            Get Token
                        </button>
                    </div>
                    <small class="captcha-hint">Group Seed: <code>251891</code></small>
                </div>

                <button type="submit" id="register-btn" class="btn btn-primary">
                    <span id="btn-text">Create Account</span>
                    <span id="btn-loader" class="loader hidden"></span>
                </button>
            </form>

            <!-- Success State -->
            <div id="success-state" class="success-state hidden">
                <div class="success-icon">âœ…</div>
                <h3>Account Created!</h3>
                <p id="success-message">Your account has been created successfully.</p>
                <a href="/" class="btn btn-primary">Go to Login</a>
            </div>

            <!-- Link to Login -->
            <div class="form-footer">
                <p>Already have an account? <a href="/">Login here</a></p>
            </div>
        </div>

        <!-- Password Strength Indicator -->
        <div class="password-strength-panel">
            <h3>ğŸ” Password Security</h3>
            <div class="strength-indicator">
                <div class="strength-bar" id="strength-bar"></div>
            </div>
            <p id="strength-text" class="strength-text">Enter a password</p>
            <ul class="password-tips">
                <li id="tip-length" class="tip-inactive">At least 4 characters</li>
                <li id="tip-number" class="tip-inactive">Contains a number</li>
                <li id="tip-special" class="tip-inactive">Contains special character</li>
                <li id="tip-upper" class="tip-inactive">Contains uppercase letter</li>
            </ul>
        </div>

        <!-- Security Info -->
        <div class="defense-panel">
            <h3>ğŸ›¡ï¸ Your Password Will Be Protected By</h3>
            <div class="defense-grid">
                <div class="defense-item active">
                    <span class="defense-icon">ğŸ”</span>
                    <span class="defense-name">Argon2id</span>
                    <span class="defense-detail">64MB memory-hard hash</span>
                </div>
                <div class="defense-item active">
                    <span class="defense-icon">ğŸŒ¶ï¸</span>
                    <span class="defense-name">Pepper</span>
                    <span class="defense-detail">Server-side secret</span>
                </div>
            </div>
        </div>
    </div>

    <script>
        const GROUP_SEED = '251891';
        const API_BASE = '';

        // DOM Elements
        const registerForm = document.getElementById('register-form');
        const statusMessage = document.getElementById('status-message');
        const captchaSection = document.getElementById('captcha-section');
        const getCaptchaBtn = document.getElementById('get-captcha-btn');
        const registerBtn = document.getElementById('register-btn');
        const btnText = document.getElementById('btn-text');
        const btnLoader = document.getElementById('btn-loader');
        const successState = document.getElementById('success-state');
        const passwordInput = document.getElementById('password');
        const confirmPasswordInput = document.getElementById('confirm_password');

        // Show status message
        function showStatus(message, type = 'info') {
            statusMessage.textContent = message;
            statusMessage.className = `status-message ${type}`;
            statusMessage.classList.remove('hidden');
            
            if (type === 'success') {
                setTimeout(() => statusMessage.classList.add('hidden'), 5000);
            }
        }

        // Hide status message
        function hideStatus() {
            statusMessage.classList.add('hidden');
        }

        // Set loading state
        function setLoading(loading) {
            registerBtn.disabled = loading;
            btnText.textContent = loading ? 'Creating Account...' : 'Create Account';
            btnLoader.classList.toggle('hidden', !loading);
        }

        // Password strength checker
        function checkPasswordStrength(password) {
            let strength = 0;
            const tips = {
                length: password.length >= 4,
                number: /\d/.test(password),
                special: /[!@#$%^&*(),.?":{}|<>]/.test(password),
                upper: /[A-Z]/.test(password)
            };

            // Update tip indicators
            document.getElementById('tip-length').className = tips.length ? 'tip-active' : 'tip-inactive';
            document.getElementById('tip-number').className = tips.number ? 'tip-active' : 'tip-inactive';
            document.getElementById('tip-special').className = tips.special ? 'tip-active' : 'tip-inactive';
            document.getElementById('tip-upper').className = tips.upper ? 'tip-active' : 'tip-inactive';

            // Calculate strength
            if (tips.length) strength++;
            if (tips.number) strength++;
            if (tips.special) strength++;
            if (tips.upper) strength++;
            if (password.length >= 8) strength++;

            // Update strength bar
            const strengthBar = document.getElementById('strength-bar');
            const strengthText = document.getElementById('strength-text');

            const strengthLevels = [
                { width: '0%', color: '#374151', text: 'Enter a password' },
                { width: '25%', color: '#ef4444', text: 'Weak' },
                { width: '50%', color: '#f59e0b', text: 'Fair' },
                { width: '75%', color: '#10b981', text: 'Good' },
                { width: '100%', color: '#22c55e', text: 'Strong' }
            ];

            const level = Math.min(strength, 4);
            strengthBar.style.width = strengthLevels[level].width;
            strengthBar.style.backgroundColor = strengthLevels[level].color;
            strengthText.textContent = strengthLevels[level].text;
        }

        // Get CAPTCHA token
        async function getCaptchaToken() {
            getCaptchaBtn.disabled = true;
            getCaptchaBtn.textContent = 'â³ Fetching...';
            
            try {
                const response = await fetch(`${API_BASE}/admin/get_captcha_token?group_seed=${GROUP_SEED}`);
                const data = await response.json();
                
                if (data.captcha_token) {
                    document.getElementById('captcha_token').value = data.captcha_token;
                    showStatus('âœ… Token fetched (Group Seed: 251891)', 'success');
                    getCaptchaBtn.textContent = 'âœ… Done';
                    setTimeout(() => { getCaptchaBtn.textContent = 'Get Token'; }, 2000);
                } else {
                    showStatus('Failed to get CAPTCHA token', 'error');
                    getCaptchaBtn.textContent = 'Retry';
                }
            } catch (error) {
                showStatus('Error: ' + error.message, 'error');
                getCaptchaBtn.textContent = 'Retry';
            }
            
            getCaptchaBtn.disabled = false;
        }

        // Handle register form submission
        registerForm.addEventListener('submit', async (e) => {
            e.preventDefault();
            hideStatus();
            
            const username = document.getElementById('username').value;
            const password = document.getElementById('password').value;
            const confirmPassword = document.getElementById('confirm_password').value;
            const captchaToken = document.getElementById('captcha_token').value;

            // Validate passwords match
            if (password !== confirmPassword) {
                showStatus('âŒ Passwords do not match', 'error');
                return;
            }

            setLoading(true);
            
            // Prepare request body
            const body = { username, password };
            
            // Add CAPTCHA token if available
            if (captchaToken) {
                body.captcha_token = captchaToken;
            }
            
            try {
                const response = await fetch(API_BASE + '/auth/register', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(body)
                });
                
                const data = await response.json();
                
                if (response.ok) {
                    // Success!
                    registerForm.classList.add('hidden');
                    successState.classList.remove('hidden');
                    document.getElementById('success-message').textContent = 
                        `Account "${username}" created successfully with ${data.hash_algorithm} hashing.`;
                    
                } else if (response.status === 403) {
                    // CAPTCHA required
                    if (data.captcha_required) {
                        captchaSection.classList.remove('hidden');
                        showStatus('ğŸ¤– CAPTCHA required. Click "Get CAPTCHA Token" to continue.', 'warning');
                        getCaptchaBtn.textContent = 'ğŸ”‘ Get Token (Group Seed: 251891)';
                    } else {
                        showStatus(data.message || data.error || 'Access forbidden', 'error');
                    }
                    
                } else if (response.status === 409) {
                    // User already exists
                    showStatus('âŒ Username already taken. Please choose another.', 'error');
                    
                } else if (response.status === 429) {
                    // Rate limited
                    showStatus('âš¡ Rate limit exceeded. Please wait a moment.', 'error');
                    
                } else if (response.status === 400) {
                    showStatus('âŒ ' + (data.error || 'Invalid input'), 'error');
                    
                } else {
                    showStatus(data.error || 'Registration failed', 'error');
                }
                
            } catch (error) {
                showStatus('Network error: ' + error.message, 'error');
            }
            
            setLoading(false);
        });

        // Password input handler
        passwordInput.addEventListener('input', (e) => {
            checkPasswordStrength(e.target.value);
        });

        // Get CAPTCHA token button handler
        getCaptchaBtn.addEventListener('click', getCaptchaToken);

        // Confirm password validation
        confirmPasswordInput.addEventListener('input', () => {
            if (confirmPasswordInput.value && confirmPasswordInput.value !== passwordInput.value) {
                confirmPasswordInput.setCustomValidity('Passwords do not match');
            } else {
                confirmPasswordInput.setCustomValidity('');
            }
        });
    </script>
</body>
</html>

